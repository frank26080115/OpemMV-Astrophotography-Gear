<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="initial-scale=1" />
<title>OpenMV AutoGuider</title>

<style type="text/css">
body
{
    background-color: #000;
    color: #EEE;
    font-size: 10pt;
}
.tbl_platesolve table, th, td {
    border: 1px solid white;
    border-collapse: collapse;
    padding: 2px 10px 2px 10px;
}
.platesolve_green {
    color: lime;
}
.hideable-msg {
    padding-left: 1em;
}
</style>

<script type="text/javascript">

var dataw = 2592;
var datah = 1944;

var socket;

function getExposureCode(exposure_code) {
    if (exposure_code == 0) {
        return "correct";
    }
    else if (exposure_code == -1) {
        return "too dark";
    }
    else if (exposure_code == -2) {
        return "no image";
    }
    else if (exposure_code == 1) {
        return "too bright";
    }
    else if (exposure_code == 2) {
        return "too noisy";
    }
    else if (exposure_code == 3) {
        return "movement";
    }
    else if (exposure_code == 4) {
        return "big blob";
    }
    else if (exposure_code == 5) {
        return "too many stars";
    }
    else if (exposure_code == 6) {
        return "INTERNAL MEMORY ERROR";
    }
    else if (exposure_code == 7) {
        return "CAMERA HARDWARE ERROR";
    }
    return "unknown";
}

function checkHotPixel(star) {
    if (hotpixels == undefined) {
        return false;
    }
    if (hotpixels == null || hotpixels == false) {
        return false;
    }
    if (hotpixels.length <= 0) {
        return false;
    }
    var i, cnt = hotpixels.length;
    for (i = 0; i < cnt; i++) {
        var v = math_getVector([star.cx, star.cy], hotpixels[i]);
        if (v[0] < 2) {
            return true;
        }
    }
    return false;
}

function slew(ele, isdown) {
    console.log("slew " + ele.id + " isdown " + isdown);
    if (isdown) {
        document.getElementById(ele.id + "_bottom").style.fill = "#08A";
    }
    else {
        document.getElementById(ele.id + "_bottom").style.fill = "#F80";
    }
}

function makeSlider(id, minval, maxval, defval, stepval, slide_func)
{
    if (defval < minval) {
        defval = minval;
    }
    if (defval > maxval) {
        defval = maxval;
    }

    var handle = $( "#" + id + "_handle" );
    $( "#" + id ).slider({
      create: function() {
        handle.text( $( this ).slider( "value" ) );
      },
      min: minval,
      max: maxval,
      step: stepval,
      value: defval,
      slide: function( event, ui ) {
        handle.text( ui.value );
        if (slide_func) {
            slide_func(this, event, ui);
        }
      }
    });
}

function onLoadAll()
{
    document.getElementById("loading").style.display = "none";
    document.getElementById("showme").style.display = "block";
    $( "#accordion" ).accordion({heightStyle: "content"});

    $("#btn_streamimg" ).button().click(function( event ) {
        console.log("click btn_streamimg");
        window.location.href = "/stream";
    });

    makeSlider("slider_gain", 0, 128, 32, 8, function(obj, event, ui) {
        console.log("slider_gain: " + ui.value);
    });
    makeSlider("slider_thresh", 0, 255, 0, 1, function(obj, event, ui) {
        console.log("slider_thresh: " + ui.value);
    });

    $("#btn_hotpixels").button().click(function( event ) {
        console.log("click btn_hotpixels");
        hotpixels = [];
        var pixstr = "";
        var settingsStr = "";
        //if (lastStatus != null) {
        //    var stars = lastStatus["stars"];
        //    stars.forEach(function(ele, idx) {
        //        //if (ele["brightness"] % 2 == 1) // odd number means contains saturated pixel
        //        // nevermind, a hot pixel isn't necessarily saturated
        //        {
        //            hotpixels.push([ele["cx"], ele["cy"]]);
        //        }
        //    });
        //}
        //else {
        //    pixstr = "Error: no data from camera";
        //}
        var divele = document.getElementById("hotpixel_list");
        if (hotpixels.length > 0)
        {
            pixstr += "<ol>";
            hotpixels.forEach(function(ele, idx) {
                pixstr += "<li>( " + math_roundPlaces(ele[0], 1) + " , " + math_roundPlaces(ele[1], 1) + " )</li>";
                settingsStr += math_roundPlaces(ele[0], 1) + "," + math_roundPlaces(ele[1], 1) + ";";
            });
            pixstr += "</ol>";
            //settings["hotpixels"] = settingsStr;
            //queueSettingsUpdate("hotpixels");
        }
        else
        {
            pixstr = "No hot-pixels detected by camera";
        }
        divele.innerHTML = pixstr;
    });

    $("#btn_forgethotpixels").button().click(function( event ) {
        console.log("click btn_forgethotpixels");
        hotpixels = [];
        var divele = document.getElementById("hotpixel_list");
        divele.innerHTML = "";
        //settings["hotpixels"] = "";
        //queueSettingsUpdate("hotpixels");
    });

    $(window).on('resize', function(e) {
        needUiRefresh = true; // this will force a re-scaling of the drawn view
    });

    //setTimeout(() => { startStatusUpdate(); }, 1000);

    websocket_init();
}

function websocket_init()
{
    var cur_url = window.location.href;
    var r = new RegExp("([a-z]+):\/\/([^\/]+)(.*)", 'i');
    var res = r.exec(cur_url);
    var domain = res[2];
    var sock_url = "ws://" + domain + "/websocket";
    console.log(sock_url);
    socket = new WebSocket(sock_url);

    socket.onopen = function (evt) {
        console.log("websocket open");
    };

    socket.onmessage = function (evt) {
        console.log("websocket message " + evt.data);
    };

    socket.onerror = function (evt) {
        console.log("websocket error " + evt.message);
        websocket_init();
    }
}

</script>

</head>
<body onload="onLoadAll();">
<div id="loading"><h2>OpenMV AutoGuider</h2><br /><h2>Loading, Please Wait! <span id="load_tries"></span></h2></div>
<div id="loading_failed" style="display:none;"><h1>Loading FAILED! Please refresh the page.</h1></div>
<div id="loading_almost" style="display:none;"><h2>OpenMV AutoGuider</h2><br /><h2>Settings loaded! Waiting for star data...</h2></div>
<div id="showme" style="display:none;">

<div style="width:100%"><fieldset style="padding-top: 1em;"><legend>OpenMV AutoGuider</legend><div id="viewme" style="display: inline-block; width:100%; padding: 0 0 0 0; margin: 0 0 0 0;"><div id="viewmejpeg" style="position: relative; z-index: 1"></div><div id="viewmesvg" style="position: relative; z-index: 2; top: 0; left: 0;">&nbsp;&nbsp;Please wait for image...</div>
</div></fieldset></div>

<div id="connection_lost" class="ui-widget" style="display: none;"><div id="connection_lost_inner" class="hideable-msg ui-state-error ui-corner-all .ui-state-error-text" ><p>Connection LOST! Attempting to re-establish...</p></div></div>
<div id="memory_error" class="ui-widget" style="display: none;"><div id="memory_error_inner" class="hideable-msg ui-state-error ui-corner-all .ui-state-error-text" ><p>INTERNAL MEMORY ERROR! Please check the camera exposure settings!</p></div></div>
<div id="camera_hardware_error" class="ui-widget" style="display: none;"><div id="camera_hardware_error_inner" class="hideable-msg ui-state-error ui-corner-all .ui-state-error-text" ><p>CAMERA HARDWARE ERROR! Please check the camera exposure settings.<br />Lower the shutter time.<br />Do a full power-off-power-on reset if the problem is not solved.</p></div></div>
<div id="mount_hardware_error" class="ui-widget" style="display: none;"><div id="mount_hardware_error_inner" class="hideable-msg ui-state-error ui-corner-all .ui-state-error-text" ><p>MOUNT HARDWARE ERROR!<br />Do a full power-off-power-on reset if the problem is not solved.</p></div></div>
<div id="camera_hardware_wait" class="ui-widget" style="display: none;"><div id="camera_hardware_wait_inner" class="hideable-msg ui-state-error ui-corner-all .ui-state-error-text" ><p>WAITING for camera to load new exposure settings...</p></div></div>

<div id="accordion">
  <h3>Auto-Guidance</h3>
  <div>
    <p>TODO: main controls here</p>
  </div>
  <h3>Intervalometer</h3>
  <div>
    <p>TODO: main controls here</p>
    <div><fieldset><legend>Dither Distance Limit: <span id="slider_ditherlimit_handle"></span></legend>
        <div id="slider_ditherlimit"></div>
    </fieldset></div>
    <div><fieldset><legend>Dither Settle Time: <span id="slider_dithertime_handle"></span></legend>
        <div id="slider_dithertime"></div>
    </fieldset></div>
    <div><fieldset><legend>Frames per Dither: <span id="slider_ditherskip_handle"></span></legend>
        <div id="slider_ditherskip"></div>
    </fieldset></div>
  </div>
  <h3>Camera Config</h3>
  <div>
    <div><button id="btn_streamimg">Stream Image Full Screen</button></div>
    <div><fieldset><legend>Image Statistics</legend>
    <div id="div_histogram"></div>
    </fieldset></div>
    <div><fieldset><legend>Camera Gain: <span id="slider_gain_handle"></span> dB</legend>
        <div id="slider_gain"></div>
    </fieldset></div>
    <div><fieldset><legend>Star Threshold: <span id="slider_thresh_handle"></span>/255</legend>
        <div id="slider_thresh"></div>
    </fieldset></div>
  </div>
  <h3>Mount Config</h3>
  <div>
    <div><fieldset><legend>Minimum Pulse: <span id="slider_pulse_minimum_handle"></span> ms</legend>
        <div id="slider_pulse_minimum"></div>
    </fieldset></div>
    <div><fieldset><legend>Calibration Step Pulse: <span id="slider_pulse_calistep_handle"></span> ms</legend>
        <div id="slider_pulse_calistep"></div>
    </fieldset></div>
    <div><fieldset><legend>Backlash Pulse: <span id="slider_pulse_backlash_handle"></span> ms</legend>
        <div id="slider_pulse_backlash"></div>
    </fieldset></div>
    <div><fieldset><legend>Settle Time: <span id="slider_pulse_settle_handle"></span> ms</legend>
        <div id="slider_pulse_settle"></div>
    </fieldset></div>
    <div><fieldset><legend>Direction Change Hysteresis: <span id="slider_dirchangehyster_handle"></span></legend>
        <div id="slider_dirchangehyster"></div>
    </fieldset></div>
    <div><fieldset><legend>Manual Slew</legend>
        <div><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" height="300">
            <circle id="slew_dec_plus_bottom"  cx="150" cy="75"  r="50" style="fill:#F80;stroke-width:2px;stroke:#FFF" />
            <text x="150" y="82" text-anchor="middle" style="font-size:20px;fill:#FFF;">DEC+</text>
            <circle id="slew_dec_plus"  cx="150" cy="75"  r="50" style="fill:#FFFFFF00;stroke:none;" onmousedown="slew(this, true)" onmouseup="slew(this, false)" onmouseout="slew(this, false)" />
            <circle id="slew_dec_minus_bottom" cx="150" cy="225" r="50" style="fill:#F80;stroke-width:2px;stroke:#FFF" />
            <text x="150" y="232" text-anchor="middle" style="font-size:20px;fill:#FFF;">DEC-</text>
            <circle id="slew_dec_minus" cx="150" cy="225" r="50" style="fill:#FFFFFF00;stroke:none;" onmousedown="slew(this, true)" onmouseup="slew(this, false)" onmouseout="slew(this, false)" />
            <circle id="slew_ra_plus_bottom"   cx="75"  cy="150" r="50" style="fill:#F80;stroke-width:2px;stroke:#FFF" />
            <text x="75" y="158" text-anchor="middle" style="font-size:20px;fill:#FFF;">RA-</text>
            <circle id="slew_ra_plus"   cx="75"  cy="150" r="50" style="fill:#FFFFFF00;stroke:none;" onmousedown="slew(this, true)" onmouseup="slew(this, false)" onmouseout="slew(this, false)" />
            <circle id="slew_ra_minus_bottom"  cx="225" cy="150" r="50" style="fill:#F80;stroke-width:2px;stroke:#FFF" />
            <text x="225" y="158" text-anchor="middle" style="font-size:20px;fill:#FFF;">RA+</text>
            <circle id="slew_ra_minus"  cx="225" cy="150" r="50" style="fill:#FFFFFF00;stroke:none;" onmousedown="slew(this, true)" onmouseup="slew(this, false)" onmouseout="slew(this, false)" />
        </svg></div>
    </fieldset></div>
  </div>
  <h3>Calibration</h3>
  <div>
    <p>TODO: calibration visualization here</p>
  </div>
  <h3>Motion Graph</h3>
  <div>
    <p>TODO: motion graph here</p>
  </div>
  <h3>Hot Pixels</h3>
  <div>
    <p>If the camera gets too hot, there will be pixels that appear to be stuck as white. These stuck pixels will be falsely detected as stars. You will notice these pixels when you see stars that do not move even though you are moving the camera around.</p>
    <p>It is possible to memorize which pixels are stuck so that they are removed from the list of stars. To do so: <ol><li>turn up the gain and shutter time slightly</li><li>cover up the camera completely</li><li>click the "capture hot pixels" button</li><li>restore your original settings</li></ol></p>
    <p>Think of this as taking a "dark frame" but not really the same thing.</p>
    <p>If a hot pixel is near where an important star exists, then rotate the camera.</p>
    <p><button id="btn_hotpixels">Capture Hot Pixels</button><button id="btn_forgethotpixels">Forget Hot Pixels</button></p>
    <p><fieldset><legend>Hot Pixel List</legend><div id="hotpixel_list"></div></fieldset></p>
  </div>
</div><!-- accordion -->
</div><!-- showme -->
</body>
</html>