<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="initial-scale=1" />
<title>OpenMV AutoGuider</title>

<!-- ignore -->
<script type="application/javascript" src="web/jquery-3.5.1.min.js"></script>
<script type="application/javascript" src="web/jquery-ui-1.12.1.min.js"></script>
<script type="application/javascript" src="web/jquery.cftoaster.1.0.1.min.js"></script>
<script type="application/javascript" src="web/chartist.min.js"></script>
<script type="application/javascript" src="web/mathutils.js"></script>
<script type="application/javascript" src="web/websocketutils.js"></script>
<link rel="stylesheet" href="web/jquery-ui-1.12.1-darkness.css" />
<link rel="stylesheet" href="web/jquery.cftoaster.1.0.1.css" />
<link rel="stylesheet" href="web/chartist.min.css" />
<!-- end ignore -->

<style type="text/css">
body
{
    background-color: #000;
    color: #EEE;
    font-size: 10pt;
}
.tbl_platesolve table, th, td {
    border: 1px solid white;
    border-collapse: collapse;
    padding: 2px 10px 2px 10px;
}
.platesolve_green {
    color: lime;
}
.hideable-msg {
    padding-left: 1em;
}
</style>

<script type="text/javascript">

var dataw = 2592;
var datah = 1944;

var socket;

function getExposureCode(exposure_code) {
    if (exposure_code == 0) {
        return "correct";
    }
    else if (exposure_code == -1) {
        return "too dark";
    }
    else if (exposure_code == -2) {
        return "no image";
    }
    else if (exposure_code == 1) {
        return "too bright";
    }
    else if (exposure_code == 2) {
        return "too noisy";
    }
    else if (exposure_code == 3) {
        return "movement";
    }
    else if (exposure_code == 4) {
        return "big blob";
    }
    else if (exposure_code == 5) {
        return "too many stars";
    }
    else if (exposure_code == 6) {
        return "INTERNAL MEMORY ERROR";
    }
    else if (exposure_code == 7) {
        return "CAMERA HARDWARE ERROR";
    }
    return "unknown";
}

function checkHotPixel(star) {
    if (hotpixels == undefined) {
        return false;
    }
    if (hotpixels == null || hotpixels == false) {
        return false;
    }
    if (hotpixels.length <= 0) {
        return false;
    }
    var i, cnt = hotpixels.length;
    for (i = 0; i < cnt; i++) {
        var v = math_getVector([star.cx, star.cy], hotpixels[i]);
        if (v[0] < 2) {
            return true;
        }
    }
    return false;
}

var ui_list = {};

function register_ui(uiele, name)
{
    ui_list[name] = uiele;
}

function makeSlider(id, minval, maxval, defval, stepval, zero_val, unit, slide_func)
{
    if (defval < minval) {
        defval = minval;
    }
    if (defval > maxval) {
        defval = maxval;
    }

    var handle = $( "#" + id + "_handle" );
    var slider = $( "#" + id ).slider({
      create: function() {
        var v = $( this ).slider( "value" );
        if (v == 0) { v = zero_val; }
        else { v = v.toString() + unit; }
        handle.text( v );
      },
      min: minval,
      max: maxval,
      step: stepval,
      value: defval,
      slide: function( event, ui ) {
        var v = ui.value;
        if (v == 0) { v = zero_val; }
        else { v = v.toString() + unit; }
        handle.text( v );
        if (slide_func) {
            slide_func(this, event, ui);
        }
      }
    });

    register_ui(slider, id);
}

function makeButton(id, click_func)
{
    var btn = $("#" + id ).button().click(click_func);
    register_ui(btn, id);
}

function onLoadAll()
{
    document.getElementById("loading").style.display = "none";
    document.getElementById("showme").style.display = "block";
    $( "#accordion" ).accordion({heightStyle: "content"});

    make_ui_intervalometer();
    make_ui_guidecamconfig();
    make_ui_mountconfig();

    $("#btn_hotpixels").button().click(function( event ) {
        console.log("click btn_hotpixels");
        hotpixels = [];
        var pixstr = "";
        var settingsStr = "";
        //if (lastStatus != null) {
        //    var stars = lastStatus["stars"];
        //    stars.forEach(function(ele, idx) {
        //        //if (ele["brightness"] % 2 == 1) // odd number means contains saturated pixel
        //        // nevermind, a hot pixel isn't necessarily saturated
        //        {
        //            hotpixels.push([ele["cx"], ele["cy"]]);
        //        }
        //    });
        //}
        //else {
        //    pixstr = "Error: no data from camera";
        //}
        var divele = document.getElementById("hotpixel_list");
        if (hotpixels.length > 0)
        {
            pixstr += "<ol>";
            hotpixels.forEach(function(ele, idx) {
                pixstr += "<li>( " + math_roundPlaces(ele[0], 1) + " , " + math_roundPlaces(ele[1], 1) + " )</li>";
                settingsStr += math_roundPlaces(ele[0], 1) + "," + math_roundPlaces(ele[1], 1) + ";";
            });
            pixstr += "</ol>";
            //settings["hotpixels"] = settingsStr;
            //queueSettingsUpdate("hotpixels");
        }
        else
        {
            pixstr = "No hot-pixels detected by camera";
        }
        divele.innerHTML = pixstr;
    });

    $("#btn_forgethotpixels").button().click(function( event ) {
        console.log("click btn_forgethotpixels");
        hotpixels = [];
        var divele = document.getElementById("hotpixel_list");
        divele.innerHTML = "";
        //settings["hotpixels"] = "";
        //queueSettingsUpdate("hotpixels");
    });

    $(window).on('resize', function(e) {
        needUiRefresh = true; // this will force a re-scaling of the drawn view
    });

    //setTimeout(() => { startStatusUpdate(); }, 1000);

    websocket_init();
}

function websocket_init()
{
    var cur_url = window.location.href;
    var r = new RegExp("([a-z]+):\/\/([^\/]+)(.*)", 'i');
    var res = r.exec(cur_url);
    var domain = res[2];
    var sock_url = "ws://" + domain + "/websocket";
    console.log(sock_url);
    socket = new WebSocket(sock_url);

    socket.onopen = function (evt) {
        console.log("websocket open");
    };

    socket.onmessage = function (evt) {
        console.log("websocket message " + evt.data);
    };

    socket.onerror = function (evt) {
        console.log("websocket error " + evt.message);
        websocket_init();
    }
}

</script>

</head>
<body onload="onLoadAll();">
<div id="loading"><h2>OpenMV AutoGuider</h2><br /><h2>Loading, Please Wait! <span id="load_tries"></span></h2></div>
<div id="loading_failed" style="display:none;"><h1>Loading FAILED! Please refresh the page.</h1></div>
<div id="loading_almost" style="display:none;"><h2>OpenMV AutoGuider</h2><br /><h2>Settings loaded! Waiting for star data...</h2></div>
<div id="showme" style="display:none;">

<div style="width:100%"><fieldset style="padding-top: 1em;"><legend>OpenMV AutoGuider</legend><div id="viewme" style="display: inline-block; width:100%; padding: 0 0 0 0; margin: 0 0 0 0;"><div id="viewmejpeg" style="position: relative; z-index: 1"></div><div id="viewmesvg" style="position: relative; z-index: 2; top: 0; left: 0;">&nbsp;&nbsp;Please wait for image...</div>
</div></fieldset></div>

<div id="connection_lost" class="ui-widget" style="display: none;"><div id="connection_lost_inner" class="hideable-msg ui-state-error ui-corner-all .ui-state-error-text" ><p>Connection LOST! Attempting to re-establish...</p></div></div>
<div id="memory_error" class="ui-widget" style="display: none;"><div id="memory_error_inner" class="hideable-msg ui-state-error ui-corner-all .ui-state-error-text" ><p>INTERNAL MEMORY ERROR! Please check the camera exposure settings!</p></div></div>
<div id="camera_hardware_error" class="ui-widget" style="display: none;"><div id="camera_hardware_error_inner" class="hideable-msg ui-state-error ui-corner-all .ui-state-error-text" ><p>CAMERA HARDWARE ERROR! Please check the camera exposure settings.<br />Lower the shutter time.<br />Do a full power-off-power-on reset if the problem is not solved.</p></div></div>
<div id="mount_hardware_error" class="ui-widget" style="display: none;"><div id="mount_hardware_error_inner" class="hideable-msg ui-state-error ui-corner-all .ui-state-error-text" ><p>MOUNT HARDWARE ERROR!<br />Do a full power-off-power-on reset if the problem is not solved.</p></div></div>
<div id="camera_hardware_wait" class="ui-widget" style="display: none;"><div id="camera_hardware_wait_inner" class="hideable-msg ui-state-error ui-corner-all .ui-state-error-text" ><p>WAITING for camera to load new exposure settings...</p></div></div>

<div id="accordion">
  <h3>Auto-Guidance</h3>
  <div>
    <p>TODO: main controls here</p>
  </div>
  <h3>Intervalometer</h3>
  <div>
    <script type="text/javascript">
function make_ui_intervalometer()
{
    makeButton("btn_interval_loop", function( event ) {
        console.log("click btn_interval_loop");
        ui_list["btn_interval_stopnext"].button("option", "disabled", false);
        ui_list["btn_interval_stopnow"] .button("option", "disabled", false);
        ui_list["btn_interval_single"]  .button("option", "disabled", true);
        ui_list["btn_interval_loop"]    .button("option", "disabled", true);
    });
    makeButton("btn_interval_single", function( event ) {
        console.log("click btn_interval_single");
        ui_list["btn_interval_stopnext"].button("option", "disabled", true);
        ui_list["btn_interval_stopnow"] .button("option", "disabled", false);
        ui_list["btn_interval_single"]  .button("option", "disabled", false);
        ui_list["btn_interval_loop"]    .button("option", "disabled", false);
    });
    makeButton("btn_interval_stopnext", function( event ) {
        console.log("click btn_interval_stopnext");
        ui_list["btn_interval_stopnext"].button("option", "disabled", true);
        ui_list["btn_interval_stopnow"] .button("option", "disabled", false);
        ui_list["btn_interval_single"]  .button("option", "disabled", true);
        ui_list["btn_interval_loop"]    .button("option", "disabled", true);
    });
    makeButton("btn_interval_stopnow", function( event ) {
        console.log("click btn_interval_stopnow");
        ui_list["btn_interval_stopnext"].button("option", "disabled", true);
        ui_list["btn_interval_stopnow"] .button("option", "disabled", true);
        ui_list["btn_interval_single"]  .button("option", "disabled", false);
        ui_list["btn_interval_loop"]    .button("option", "disabled", false);
    });
    makeSlider("slider_bulbtime", 0, 1200, 30, 1, "0 sec", " sec", function(obj, event, ui) {
        console.log("slider_bulbtime: " + ui.value);
    });
    makeSlider("slider_ditherlimit", 0, 500, 10, 1, "OFF", " pix", function(obj, event, ui) {
        console.log("slider_ditherlimit: " + ui.value);
    });
    makeSlider("slider_dithersettlethresh", 0, 10, 3, 1, "0 pix", " pix", function(obj, event, ui) {
        console.log("slider_dithersettlethresh: " + ui.value);
    });
    makeSlider("slider_dithersettleframecnt", 1, 10, 3, 1, "0 frames", " frames", function(obj, event, ui) {
        console.log("slider_dithersettleframecnt: " + ui.value);
    });
    makeSlider("slider_dithertimeout", 1, 10, 5, 1, "0 frames", " frames", function(obj, event, ui) {
        console.log("slider_dithertimeout: " + ui.value);
    });

    // TODO: digital intervalometer mode
}
    </script>
    <p><button id="btn_interval_loop">Loop</button><button id="btn_interval_single">Single</button><button id="btn_interval_stopnext">Stop On Next</button><button id="btn_interval_stopnow">Stop Now</button></p>
    <div><fieldset><legend>Status:</legend>
        <div id="bulb_status" style="font-size:20pt;">0</div>
    </fieldset></div>
    <div><fieldset><legend>Bulb Time: <span id="slider_bulbtime_handle"></span></legend>
        <div id="slider_bulbtime"></div>
    </fieldset></div>
    <div><fieldset><legend>Dither Dist. Limit (0 to disable dithering): <span id="slider_ditherlimit_handle"></span></legend>
        <div id="slider_ditherlimit"></div>
    </fieldset></div>
    <div><fieldset><legend>Dither Settle Thresh: <span id="slider_dithersettlethresh_handle"></span></legend>
        <div id="slider_dithersettlethresh"></div>
    </fieldset></div>
    <div><fieldset><legend>Dither Settle Frame Count: <span id="slider_dithersettleframecnt_handle"></span></legend>
        <div id="slider_dithersettleframecnt"></div>
    </fieldset></div>
    <div><fieldset><legend>Dither Timeout Frame Count: <span id="slider_dithertimeout_handle"></span></legend>
        <div id="slider_dithertimeout"></div>
    </fieldset></div>
    <!-- TODO: digital intervalometer mode -->
  </div>
  <h3>Guide-Cam Config</h3>
  <div>
    <script type="text/javascript">

function make_ui_guidecamconfig()
{
    $("#btn_streamimg" ).button().click(function( event ) {
        console.log("click btn_streamimg");
        window.location.href = "/stream";
    });
    $("#btn_streamimg_star" ).button().click(function( event ) {
        console.log("click btn_streamimg_star");
        window.location.href = "/stream?zoom";
    });

    makeSlider("slider_gain", 0, 128, 32, 8, "0 dB", " dB", function(obj, event, ui) {
        console.log("slider_gain: " + ui.value);
    });
    makeSlider("slider_shutter", 100, 3000, 1000, 100, "0", " ms", function(obj, event, ui) {
        console.log("slider_shutter: " + ui.value);
    });
    makeSlider("slider_starthresh", 0, 255, 0, 1, "auto", "/255", function(obj, event, ui) {
        console.log("slider_starthresh: " + ui.value);
    });
    makeSlider("slider_imgerrpanicthresh", 1, 100, 3, 1, "0", "", function(obj, event, ui) {
        console.log("slider_imgerrpanicthresh: " + ui.value);
    });
}

    </script>
    <div><button id="btn_streamimg">Stream Image Full Screen</button><button id="btn_streamimg_star">Stream Image of Selected Star</button></div>
    <div><fieldset><legend>Image Statistics</legend>
    <div id="div_histogram"></div>
    </fieldset></div>
    <div><fieldset><legend>Camera Gain: <span id="slider_gain_handle"></span></legend>
        <div id="slider_gain"></div>
    </fieldset></div>
    <div><fieldset><legend>Shutter: <span id="slider_shutter_handle"></span></legend>
        <div id="slider_shutter"></div>
    </fieldset></div>
    <div><fieldset><legend>Star Threshold: <span id="slider_starthresh_handle"></span></legend>
        <div id="slider_starthresh"></div>
    </fieldset></div>
    <div><fieldset><legend>Image Error Panic Threshold: <span id="slider_imgerrpanicthresh_handle"></span></legend>
        <div id="slider_imgerrpanicthresh"></div>
    </fieldset></div>
  </div>
  <h3>Mount Config</h3>
  <div>
    <script type="text/javascript">
function make_ui_mountconfig()
{
    makeSlider("slider_pulse_minimum", 10, 500, 50, 1, "0 ms", " ms", function(obj, event, ui) {
        console.log("slider_pulse_minimum: " + ui.value);
    });
    makeSlider("slider_pulse_maximum", 0, 3000, 900, 100, "auto", " ms", function(obj, event, ui) {
        console.log("slider_pulse_maximum: " + ui.value);
    });
    makeSlider("slider_pulse_calistep", 100, 5000, 900, 100, "0 ms", " ms", function(obj, event, ui) {
        console.log("slider_pulse_calistep: " + ui.value);
    });
    makeSlider("slider_pulse_settle", 0, 500, 50, 1, "0 ms", " ms", function(obj, event, ui) {
        console.log("slider_pulse_settle: " + ui.value);
    });
    makeSlider("slider_dirchangehyster", 0, 5000, 500, 1, "0 ms", " ms", function(obj, event, ui) {
        console.log("slider_dirchangehyster: " + ui.value);
    });
    makeSlider("slider_backlashlimit", 0, 10000, 5000, 100, "0 ms", " ms", function(obj, event, ui) {
        console.log("slider_backlashlimit: " + ui.value);
    });
}
    </script>
    <div><fieldset><legend>Minimum Pulse: <span id="slider_pulse_minimum_handle"></span></legend>
        <div id="slider_pulse_minimum"></div>
    </fieldset></div>
    <div><fieldset><legend>Maximum Pulse: <span id="slider_pulse_maximum_handle"></span></legend>
        <div id="slider_pulse_maximum"></div>
    </fieldset></div>
    <div><fieldset><legend>Calibration Step Pulse: <span id="slider_pulse_calistep_handle"></span> ms</legend>
        <div id="slider_pulse_calistep"></div>
    </fieldset></div>
    <div><fieldset><legend>Settle Time: <span id="slider_pulse_settle_handle"></span></legend>
        <div id="slider_pulse_settle"></div>
    </fieldset></div>
    <div><fieldset><legend>Direction Change Hysteresis: <span id="slider_dirchangehyster_handle"></span> ms</legend>
        <div id="slider_dirchangehyster"></div>
    </fieldset></div>
    <div><fieldset><legend>Backlash Limiter: <span id="slider_backlashlimit_handle"></span></legend>
        <div id="slider_backlashlimit"></div>
    </fieldset></div>
  </div>
  <h3>Calibration</h3>
  <div>
    <p>TODO: calibration visualization here</p>
  </div>
  <h3>Analysis Parameters</h3>
  <div>
    <p>TODO: blah blah blah</p>
    <div><fieldset><legend>Stars Used: <span id="slider_multistar_handle"></span></legend>
        <div id="slider_multistar"></div>
    </fieldset></div>
    <div><fieldset><legend>Motion Error Tolerance: <span id="slider_motionerrortolerance_handle"></span></legend>
        <div id="slider_motionerrortolerance"></div>
    </fieldset></div>
    <div><fieldset><legend>Motion Error Panic Thresh: <span id="slider_motionerrorpanicthresh_handle"></span></legend>
        <div id="slider_motionerrorpanicthresh"></div>
    </fieldset></div>
    <div><fieldset><legend>Multi-Star Rating Thresh: <span id="slider_multistarratingthresh_handle"></span></legend>
        <div id="slider_multistarratingthresh"></div>
    </fieldset></div>
    <div><fieldset><legend>Cluster Tolerance: <span id="slider_clustertolerance_handle"></span></legend>
        <div id="slider_clustertolerance"></div>
    </fieldset></div>
    <div><p><label for="chk_fastanalysis">Fast Analysis Mode?</label><input type="checkbox" name="chk_fastanalysis" id="chk_fastanalysis"></p></div>
    <div><p><label for="chk_fullstarprofile">Fully Profile Star?</label><input type="checkbox" name="chk_fullstarprofile" id="chk_fullstarprofile"></p></div>
  </div>
  <h3>Hot Pixels</h3>
  <div>
    <p>If the camera gets too hot, there will be pixels that appear to be stuck as white. These stuck pixels will be falsely detected as stars. You will notice these pixels when you see stars that do not move even though you are moving the camera around.</p>
    <p>It is possible to memorize which pixels are stuck so that they are removed from the list of stars. To do so: <ol><li>turn up the gain and shutter time slightly</li><li>cover up the camera completely</li><li>click the "capture hot pixels" button</li><li>restore your original settings</li></ol></p>
    <p>Think of this as taking a "dark frame" but not really the same thing.</p>
    <p>If a hot pixel is near where an important star exists, then rotate the camera.</p>
    <p><button id="btn_hotpixels">Capture Hot Pixels</button><button id="btn_forgethotpixels">Forget Hot Pixels</button></p>
    <p><fieldset><legend>Hot Pixel List</legend><div id="hotpixel_list"></div></fieldset></p>
  </div>
</div><!-- accordion -->
</div><!-- showme -->
</body>
</html>